<!-- SPDX-FileCopyrightText: 2025 Georges Martin <jrjsmrtn@gmail.com> -->
<!-- SPDX-License-Identifier: MIT -->
<tal:block metal:use-macro="templates/page/macros/icing">
<title metal:fill-slot="head_title">
<tal:block condition="context/id" i18n:translate=""
 >Change <tal:x tal:content="context/id" i18n:name="id"
 />: <tal:x content="context/title" i18n:name="title"
 /> - <tal:x content="config/TRACKER_NAME" i18n:name="tracker"
/></tal:block>
<tal:block condition="not:context/id" i18n:translate=""
 >New Change Request - <span tal:replace="config/TRACKER_NAME" i18n:name="tracker"
/></tal:block>
</title>
<tal:block metal:fill-slot="body_title">
 <span tal:condition="python: not (context.id or context.is_edit_ok())"
  tal:omit-tag="python:1" i18n:translate="">New Change Request</span>
 <span tal:condition="python: not context.id and context.is_edit_ok()"
  tal:omit-tag="python:1" i18n:translate="">New Change Request Editing</span>
 <span tal:condition="python: context.id and not context.is_edit_ok()"
  tal:omit-tag="python:1" i18n:translate="">Change<tal:x
  replace="context/id" i18n:name="id" /></span>
 <span tal:condition="python: context.id and context.is_edit_ok()"
  tal:omit-tag="python:1" i18n:translate="">Change<tal:x
  replace="context/id" i18n:name="id" /> Editing</span>
</tal:block>

<td class="content" metal:fill-slot="content">

<p tal:condition="python:not (context.is_view_ok()
 or request.user.hasRole('Anonymous'))" i18n:translate="">
 You are not allowed to view this page.</p>

<p tal:condition="python:not context.is_view_ok()
 and request.user.hasRole('Anonymous')" i18n:translate="">
 Please login with your username and password.</p>

<div tal:condition="context/is_view_ok">

<form method="POST" name="changeForm"
      onSubmit="return submit_once()" enctype="multipart/form-data"
      tal:attributes="action context/designator">

<table class="form">
<tr>
 <th class="required" i18n:translate="">Title</th>
 <td colspan=3 tal:content="structure python:context.title.field(size=60)">title</td>
</tr>

<tr>
 <th class="required" i18n:translate="">Justification</th>
 <td colspan=3>
  <textarea name="justification" rows="3" cols="60"
            tal:content="python:context.justification.plain()"
  ></textarea>
 </td>
</tr>

<tr>
 <th i18n:translate="">Description</th>
 <td colspan=3>
  <textarea name="description" rows="5" cols="60"
            tal:content="python:context.description.plain()"
  ></textarea>
 </td>
</tr>

<tr>
 <th i18n:translate="">Impact Assessment</th>
 <td colspan=3>
  <textarea name="impact" rows="3" cols="60"
            tal:content="python:context.impact.plain()"
  ></textarea>
 </td>
</tr>

<tr>
 <th i18n:translate="">Risk Assessment</th>
 <td colspan=3>
  <textarea name="risk" rows="3" cols="60"
            tal:content="python:context.risk.plain()"
  ></textarea>
 </td>
</tr>

<tr>
 <th class="required" i18n:translate="">Priority</th>
 <td tal:content="structure context/priority/menu">priority</td>
 <th class="required" i18n:translate="">Category</th>
 <td tal:content="structure context/category/menu">category</td>
</tr>

<tr>
 <th i18n:translate="">Status</th>
 <td tal:content="structure context/status/menu">status</td>
 <th i18n:translate="">Assigned To</th>
 <td tal:content="structure context/assignedto/menu">assignedto</td>
</tr>

<tr>
 <th i18n:translate="">Related Issues</th>
 <td colspan=3>
  <span tal:replace="structure python:context.related_issues.field(showid=1, size=30)" />
  <roundup-classhelper data-search-with="title,status[],priority[],id">
    <span tal:condition="context/is_edit_ok"
          tal:replace="structure python:db.issue.classhelp('id,title',
                       property='related_issues')" />
  </roundup-classhelper>
 </td>
</tr>

<tr>
 <th i18n:translate="">Target CIs</th>
 <td colspan=3>
  <span tal:replace="structure context/target_cis/field" />
  <roundup-classhelper data-search-with="name,type[],status[],criticality[]">
    <span tal:condition="context/is_edit_ok"
          tal:replace="structure python:db.ci.classhelp('id,name,type,criticality',
                       property='target_cis', width='600')" />
  </roundup-classhelper>
  <tal:block tal:condition="context/target_cis">
   <br><span i18n:translate="">View:</span>
   <ul style="margin: 0; padding-left: 20px;">
    <li tal:repeat="ci context/target_cis">
     <a tal:attributes="href string:ci${ci/id}"
        tal:content="python:f'{ci.name} ({ci.type.name})'">CI link</a>
     <tal:block tal:condition="python:hasattr(ci, 'criticality') and ci.criticality">
      - Criticality: <strong tal:content="python:db.cicriticality.get(ci.criticality, 'name')">criticality</strong>
      <tal:block tal:define="crit_name python:db.cicriticality.get(ci.criticality, 'name')">
       <tal:block tal:condition="python:crit_name in ['High', 'Very High']">
        <br><span style="color: #d32f2f; font-weight: bold;">
         âš  WARNING: This change affects a <tal:x tal:replace="python:crit_name.lower()">criticality</tal:x> criticality component
        </span>
       </tal:block>
      </tal:block>
     </tal:block>
     <!-- Show dependent CIs if any -->
     <tal:block tal:define="dependents python:db.cirelationship.filter(None, {'target_ci': ci.id})">
      <tal:block tal:condition="dependents">
       <br><span style="color: #f57c00;">
        <em>Impact: This CI supports <tal:x tal:replace="python:len(dependents)">count</tal:x> dependent CI<tal:x tal:condition="python:len(dependents) > 1">s</tal:x></em>
       </span>
       <ul style="margin: 5px 0; padding-left: 20px; font-size: 0.9em;">
        <li tal:repeat="rel_id dependents">
         <tal:block tal:define="rel python:db.cirelationship.getnode(rel_id);
                                source_ci python:db.ci.getnode(rel.source_ci)">
          <a tal:attributes="href string:ci${source_ci.id}"
             tal:content="source_ci/name">dependent CI</a>
          (<tal:x tal:replace="python:db.cirelationshiptype.get(rel.relationship_type, 'name')">relationship</tal:x>)
         </tal:block>
        </li>
       </ul>
      </tal:block>
     </tal:block>
    </li>
   </ul>
  </tal:block>
 </td>
</tr>

<tr tal:condition="context/is_edit_ok">
 <th i18n:translate="">Nosy List</th>
 <td colspan=3>
  <span tal:replace="structure context/nosy/field" />
  <roundup-classhelper
    tal:define="search string:username,realname"
    tal:attributes="data-search-with search">
    <span tal:condition="context/is_edit_ok"
          tal:replace="structure
                       python:db.user.classhelp(
                       'username,realname',
                       property='nosy',
                       width='600')" /></roundup-classhelper>
 </td>
</tr>

<tr tal:condition="context/is_edit_ok">
 <th i18n:translate="">Change Note</th>
 <td colspan=3>
  <textarea tal:content="request/form/@note/value | default"
            name="@note" wrap="hard" rows="3" cols="60"></textarea>
 </td>
</tr>

<tr tal:condition="context/is_edit_ok">
 <th i18n:translate="">File</th>
 <td colspan=3><input type="file" name="@file" size="40"></td>
</tr>

<tr tal:condition="context/is_edit_ok">
 <td>
  &nbsp;
  <input type="hidden" name="@template" value="item">
  <input type="hidden" name="@required" value="title,justification,priority,category">
 </td>
 <td colspan=3>
  <span tal:replace="structure context/submit">submit button</span>
 </td>
</tr>

</table>
</form>

<!-- Workflow Action Buttons -->
<div tal:condition="python:context.id and context.is_view_ok()" style="margin: 20px 0; padding: 10px; background-color: #f5f5f5; border: 1px solid #ddd;">
 <strong i18n:translate="">Workflow Actions:</strong>

 <!-- Approve button: shown when status is "planning" -->
 <form tal:condition="python:context.status.id == '1'"
       method="POST" style="display:inline; margin-left: 10px;"
       tal:attributes="action context/designator">
  <input type="hidden" name="status" value="2">
  <input type="hidden" name="@action" value="edit">
  <input type="hidden" name="@template" value="item">
  <input name="@csrf" type="hidden" tal:attributes="value python:utils.anti_csrf_nonce()">
  <input type="submit" value="Approve" i18n:attributes="value">
 </form>

 <!-- Cancel button: shown when status is "planning" -->
 <form tal:condition="python:context.status.id == '1'"
       method="POST" style="display:inline; margin-left: 10px;"
       tal:attributes="action context/designator">
  <input type="hidden" name="status" value="5">
  <input type="hidden" name="@action" value="edit">
  <input type="hidden" name="@template" value="item">
  <input name="@csrf" type="hidden" tal:attributes="value python:utils.anti_csrf_nonce()">
  <input type="submit" value="Reject" i18n:attributes="value"
         onclick="return confirm('Are you sure you want to reject this change?');">
 </form>

 <!-- Start Implementation button: shown when status is "approved" -->
 <form tal:condition="python:context.status.id == '2'"
       method="POST" style="display:inline; margin-left: 10px;"
       tal:attributes="action context/designator">
  <input type="hidden" name="status" value="3">
  <input type="hidden" name="@action" value="edit">
  <input type="hidden" name="@template" value="item">
  <input name="@csrf" type="hidden" tal:attributes="value python:utils.anti_csrf_nonce()">
  <input type="submit" value="Start Implementation" i18n:attributes="value">
 </form>

 <!-- Cancel button: shown when status is "approved" -->
 <form tal:condition="python:context.status.id == '2'"
       method="POST" style="display:inline; margin-left: 10px;"
       tal:attributes="action context/designator">
  <input type="hidden" name="status" value="5">
  <input type="hidden" name="@action" value="edit">
  <input type="hidden" name="@template" value="item">
  <input name="@csrf" type="hidden" tal:attributes="value python:utils.anti_csrf_nonce()">
  <input type="submit" value="Cancel" i18n:attributes="value"
         onclick="return confirm('Are you sure you want to cancel this change?');">
 </form>

 <!-- Mark Complete button: shown when status is "implementing" -->
 <form tal:condition="python:context.status.id == '3'"
       method="POST" style="display:inline; margin-left: 10px;"
       tal:attributes="action context/designator">
  <input type="hidden" name="status" value="4">
  <input type="hidden" name="@action" value="edit">
  <input type="hidden" name="@template" value="item">
  <input name="@csrf" type="hidden" tal:attributes="value python:utils.anti_csrf_nonce()">
  <input type="submit" value="Mark Complete" i18n:attributes="value">
 </form>

 <!-- Rollback button: shown when status is "implementing" -->
 <form tal:condition="python:context.status.id == '3'"
       method="POST" style="display:inline; margin-left: 10px;"
       tal:attributes="action context/designator">
  <input type="hidden" name="status" value="5">
  <input type="hidden" name="@action" value="edit">
  <input type="hidden" name="@template" value="item">
  <input name="@csrf" type="hidden" tal:attributes="value python:utils.anti_csrf_nonce()">
  <input type="submit" value="Rollback" i18n:attributes="value"
         onclick="return confirm('Are you sure you want to rollback this change?');">
 </form>

 <!-- No actions for completed or cancelled -->
 <span tal:condition="python:context.status.id in ['4', '5']" i18n:translate="">
  No workflow actions available (change is in terminal state)
 </span>
</div>

<!-- Display history for existing changes -->
<div tal:condition="context/id">
 <h2 i18n:translate="">Messages</h2>
 <tal:block tal:condition="context/messages">
  <tal:block tal:repeat="msg context/messages">
   <div tal:replace="structure python:msg.item()" />
  </tal:block>
 </tal:block>
 <tal:block tal:condition="not:context/messages">
  <p i18n:translate="">No messages</p>
 </tal:block>

 <h2 i18n:translate="">History</h2>
 <tal:block tal:replace="structure context/history" />
</div>

</div>

</td>
</tal:block>
