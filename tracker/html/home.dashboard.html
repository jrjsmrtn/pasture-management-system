<!-- SPDX-FileCopyrightText: 2025 Georges Martin <jrjsmrtn@gmail.com> -->
<!-- SPDX-License-Identifier: MIT -->
<tal:block metal:use-macro="templates/page/macros/icing">
<title metal:fill-slot="head_title">
  <span tal:omit-tag="true">CMDB Dashboard</span>
  - <span tal:replace="config/TRACKER_NAME" />
</title>

<span metal:fill-slot="more-javascript">
<style type="text/css">
  /* Dashboard Layout */
  .dashboard {
    max-width: 1200px;
    margin: 0 auto;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }

  /* Dashboard Card */
  .dashboard-card {
    background: #ffffff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .dashboard-card h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #333;
    font-size: 1.2em;
    border-bottom: 2px solid #4CAF50;
    padding-bottom: 10px;
  }

  /* Statistics Grid */
  .stat-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin: 10px 0;
  }

  .stat-item {
    padding: 10px;
    background: #f9f9f9;
    border-radius: 4px;
  }

  .stat-label {
    font-size: 0.9em;
    color: #666;
  }

  .stat-value {
    font-size: 2em;
    font-weight: bold;
    color: #4CAF50;
  }

  /* Progress Bar Chart */
  .chart-bar {
    margin: 10px 0;
  }

  .chart-bar-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-size: 0.9em;
  }

  .chart-bar-container {
    width: 100%;
    height: 24px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
  }

  .chart-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #45a049);
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 8px;
    color: white;
    font-weight: bold;
    font-size: 0.85em;
  }

  /* Criticality Colors */
  .crit-very-high { background: linear-gradient(90deg, #f44336, #da190b); }
  .crit-high { background: linear-gradient(90deg, #ff9800, #fb8c00); }
  .crit-medium { background: linear-gradient(90deg, #ffeb3b, #fdd835); color: #333 !important; }
  .crit-low { background: linear-gradient(90deg, #8bc34a, #7cb342); }
  .crit-very-low { background: linear-gradient(90deg, #9e9e9e, #757575); }

  /* Action Buttons */
  .dashboard-actions {
    margin: 20px 0;
    text-align: right;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    margin-left: 10px;
  }

  .btn-primary {
    background: #4CAF50;
    color: white;
  }

  .btn-secondary {
    background: #757575;
    color: white;
  }

  .btn:hover {
    opacity: 0.9;
  }

  /* Summary Stats */
  .summary-stats {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 20px;
    margin: 20px 0;
  }

  .summary-stat {
    text-align: center;
    min-width: 150px;
  }

  .summary-stat-value {
    font-size: 3em;
    font-weight: bold;
    color: #4CAF50;
  }

  .summary-stat-label {
    font-size: 1em;
    color: #666;
    margin-top: 5px;
  }
</style>
</span>

<span metal:fill-slot="body_title" tal:omit-tag="true">
  CMDB Dashboard
</span>

<td class="content" metal:fill-slot="content">

<p tal:condition="python:not request.user.hasPermission('View', 'ci')">
 You are not allowed to view this page.</p>

<tal:block tal:condition="python:request.user.hasPermission('View', 'ci')">

<div class="dashboard">
  <!-- Action Buttons -->
  <div class="dashboard-actions">
    <a href="ci?@template=item" class="btn btn-primary">New CI</a>
    <a href="ci" class="btn btn-secondary">View All CIs</a>
  </div>

  <!-- CMDB Overview Summary -->
  <tal:block tal:define="
    all_ci_ids python:db.ci.list();
    total_cis python:len(all_ci_ids);
    active_cis python:len(db.ci.filter(None, {'status': '5'}));
    retired_cis python:len(db.ci.filter(None, {'status': '7'}));
    maintenance_cis python:len(db.ci.filter(None, {'status': '6'}));
  ">
    <div class="summary-stats">
      <div class="summary-stat">
        <div class="summary-stat-value" tal:content="total_cis">0</div>
        <div class="summary-stat-label">Total CIs</div>
      </div>
      <div class="summary-stat">
        <div class="summary-stat-value" tal:content="active_cis" style="color: #4CAF50;">0</div>
        <div class="summary-stat-label">Active</div>
      </div>
      <div class="summary-stat">
        <div class="summary-stat-value" tal:content="retired_cis" style="color: #757575;">0</div>
        <div class="summary-stat-label">Retired</div>
      </div>
      <div class="summary-stat">
        <div class="summary-stat-value" tal:content="maintenance_cis" style="color: #ff9800;">0</div>
        <div class="summary-stat-label">In Maintenance</div>
      </div>
    </div>
  </tal:block>

  <!-- Dashboard Grid -->
  <div class="dashboard-grid">

    <!-- By Type -->
    <div class="dashboard-card" tal:define="
      all_ci_ids python:db.ci.list();
      total_cis python:len(all_ci_ids);
      servers python:len(db.ci.filter(None, {'type': '1'}));
      network_devices python:len(db.ci.filter(None, {'type': '2'}));
      storage python:len(db.ci.filter(None, {'type': '3'}));
      software python:len(db.ci.filter(None, {'type': '4'}));
      services python:len(db.ci.filter(None, {'type': '5'}));
      vms python:len(db.ci.filter(None, {'type': '6'}));
    ">
      <h3>By Type</h3>

      <div class="chart-bar">
        <div class="chart-bar-label">
          <span>Servers</span>
          <span tal:content="servers">0</span>
        </div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill"
               tal:attributes="style python:'width: %d%%' % (servers * 100 / total_cis if total_cis > 0 else 0)"
               tal:content="python:'%d%%' % (servers * 100 / total_cis if total_cis > 0 else 0)">0%</div>
        </div>
      </div>

      <div class="chart-bar">
        <div class="chart-bar-label">
          <span>Network Devices</span>
          <span tal:content="network_devices">0</span>
        </div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill"
               tal:attributes="style python:'width: %d%%' % (network_devices * 100 / total_cis if total_cis > 0 else 0)"
               tal:content="python:'%d%%' % (network_devices * 100 / total_cis if total_cis > 0 else 0)">0%</div>
        </div>
      </div>

      <div class="chart-bar">
        <div class="chart-bar-label">
          <span>Storage</span>
          <span tal:content="storage">0</span>
        </div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill"
               tal:attributes="style python:'width: %d%%' % (storage * 100 / total_cis if total_cis > 0 else 0)"
               tal:content="python:'%d%%' % (storage * 100 / total_cis if total_cis > 0 else 0)">0%</div>
        </div>
      </div>

      <div class="chart-bar">
        <div class="chart-bar-label">
          <span>Software</span>
          <span tal:content="software">0</span>
        </div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill"
               tal:attributes="style python:'width: %d%%' % (software * 100 / total_cis if total_cis > 0 else 0)"
               tal:content="python:'%d%%' % (software * 100 / total_cis if total_cis > 0 else 0)">0%</div>
        </div>
      </div>

      <div class="chart-bar">
        <div class="chart-bar-label">
          <span>Services</span>
          <span tal:content="services">0</span>
        </div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill"
               tal:attributes="style python:'width: %d%%' % (services * 100 / total_cis if total_cis > 0 else 0)"
               tal:content="python:'%d%%' % (services * 100 / total_cis if total_cis > 0 else 0)">0%</div>
        </div>
      </div>

      <div class="chart-bar">
        <div class="chart-bar-label">
          <span>Virtual Machines</span>
          <span tal:content="vms">0</span>
        </div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill"
               tal:attributes="style python:'width: %d%%' % (vms * 100 / total_cis if total_cis > 0 else 0)"
               tal:content="python:'%d%%' % (vms * 100 / total_cis if total_cis > 0 else 0)">0%</div>
        </div>
      </div>
    </div>

    <!-- By Criticality -->
    <div class="dashboard-card" tal:define="
      all_ci_ids python:db.ci.list();
      total_cis python:len(all_ci_ids);
      very_high python:len(db.ci.filter(None, {'criticality': '5'}));
      high python:len(db.ci.filter(None, {'criticality': '4'}));
      medium python:len(db.ci.filter(None, {'criticality': '3'}));
      low python:len(db.ci.filter(None, {'criticality': '2'}));
      very_low python:len(db.ci.filter(None, {'criticality': '1'}));
    ">
      <h3>By Criticality</h3>

      <div class="chart-bar">
        <div class="chart-bar-label">
          <span>Very High</span>
          <span tal:content="very_high">0</span>
        </div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill crit-very-high"
               tal:attributes="style python:'width: %d%%' % (very_high * 100 / total_cis if total_cis > 0 else 0)"
               tal:content="python:'%d%%' % (very_high * 100 / total_cis if total_cis > 0 else 0)">0%</div>
        </div>
      </div>

      <div class="chart-bar">
        <div class="chart-bar-label">
          <span>High</span>
          <span tal:content="high">0</span>
        </div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill crit-high"
               tal:attributes="style python:'width: %d%%' % (high * 100 / total_cis if total_cis > 0 else 0)"
               tal:content="python:'%d%%' % (high * 100 / total_cis if total_cis > 0 else 0)">0%</div>
        </div>
      </div>

      <div class="chart-bar">
        <div class="chart-bar-label">
          <span>Medium</span>
          <span tal:content="medium">0</span>
        </div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill crit-medium"
               tal:attributes="style python:'width: %d%%' % (medium * 100 / total_cis if total_cis > 0 else 0)"
               tal:content="python:'%d%%' % (medium * 100 / total_cis if total_cis > 0 else 0)">0%</div>
        </div>
      </div>

      <div class="chart-bar">
        <div class="chart-bar-label">
          <span>Low</span>
          <span tal:content="low">0</span>
        </div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill crit-low"
               tal:attributes="style python:'width: %d%%' % (low * 100 / total_cis if total_cis > 0 else 0)"
               tal:content="python:'%d%%' % (low * 100 / total_cis if total_cis > 0 else 0)">0%</div>
        </div>
      </div>

      <div class="chart-bar">
        <div class="chart-bar-label">
          <span>Very Low</span>
          <span tal:content="very_low">0</span>
        </div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill crit-very-low"
               tal:attributes="style python:'width: %d%%' % (very_low * 100 / total_cis if total_cis > 0 else 0)"
               tal:content="python:'%d%%' % (very_low * 100 / total_cis if total_cis > 0 else 0)">0%</div>
        </div>
      </div>
    </div>

    <!-- By Status -->
    <div class="dashboard-card" tal:define="
      all_ci_ids python:db.ci.list();
      total_cis python:len(all_ci_ids);
      planning python:len(db.ci.filter(None, {'status': '1'}));
      ordered python:len(db.ci.filter(None, {'status': '2'}));
      in_stock python:len(db.ci.filter(None, {'status': '3'}));
      deployed python:len(db.ci.filter(None, {'status': '4'}));
      active python:len(db.ci.filter(None, {'status': '5'}));
      maintenance python:len(db.ci.filter(None, {'status': '6'}));
      retired python:len(db.ci.filter(None, {'status': '7'}));
    ">
      <h3>By Status</h3>
      <div class="stat-grid">
        <div class="stat-item">
          <div class="stat-label">Planning</div>
          <div class="stat-value" style="font-size: 1.5em;" tal:content="planning">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Ordered</div>
          <div class="stat-value" style="font-size: 1.5em;" tal:content="ordered">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">In Stock</div>
          <div class="stat-value" style="font-size: 1.5em;" tal:content="in_stock">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Deployed</div>
          <div class="stat-value" style="font-size: 1.5em;" tal:content="deployed">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Active</div>
          <div class="stat-value" style="font-size: 1.5em; color: #4CAF50;" tal:content="active">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Maintenance</div>
          <div class="stat-value" style="font-size: 1.5em; color: #ff9800;" tal:content="maintenance">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Retired</div>
          <div class="stat-value" style="font-size: 1.5em; color: #757575;" tal:content="retired">0</div>
        </div>
      </div>
    </div>

    <!-- Relationships -->
    <div class="dashboard-card" tal:define="
      all_relationships python:db.cirelationship.list();
      total_relationships python:len(all_relationships);
      depends_on python:len(db.cirelationship.filter(None, {'relationship_type': '1'}));
      hosts python:len(db.cirelationship.filter(None, {'relationship_type': '2'}));
      connects_to python:len(db.cirelationship.filter(None, {'relationship_type': '3'}));
      runs_on python:len(db.cirelationship.filter(None, {'relationship_type': '4'}));
    ">
      <h3>Relationships</h3>
      <div class="stat-grid">
        <div class="stat-item">
          <div class="stat-label">Total</div>
          <div class="stat-value" style="font-size: 1.5em;" tal:content="total_relationships">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Depends On</div>
          <div class="stat-value" style="font-size: 1.5em;" tal:content="depends_on">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Hosts</div>
          <div class="stat-value" style="font-size: 1.5em;" tal:content="hosts">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Connects To</div>
          <div class="stat-value" style="font-size: 1.5em;" tal:content="connects_to">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Runs On</div>
          <div class="stat-value" style="font-size: 1.5em;" tal:content="runs_on">0</div>
        </div>
      </div>
    </div>

    <!-- Issues & Changes -->
    <div class="dashboard-card" tal:define="
      all_issues python:db.issue.list();
      all_changes python:db.change.list();
      total_issues python:len(all_issues);
      total_changes python:len(all_changes);
    ">
      <h3>Issues & Changes</h3>
      <div class="stat-grid">
        <div class="stat-item">
          <div class="stat-label">Total Issues</div>
          <div class="stat-value" style="font-size: 1.5em;" tal:content="total_issues">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Total Changes</div>
          <div class="stat-value" style="font-size: 1.5em;" tal:content="total_changes">0</div>
        </div>
      </div>
    </div>

  </div>

</div>

</tal:block>

</td>
</tal:block>
