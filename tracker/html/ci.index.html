<!-- SPDX-FileCopyrightText: 2025 Georges Martin <jrjsmrtn@gmail.com> -->
<!-- SPDX-License-Identifier: MIT -->
<tal:block metal:use-macro="templates/page/macros/icing">
<title metal:fill-slot="head_title">
  <span tal:omit-tag="true">CMDB - Configuration Items</span>
  - <span tal:replace="config/TRACKER_NAME" />
</title>
<span metal:fill-slot="body_title" tal:omit-tag="true">
  CMDB - Configuration Items
</span>
<td class="content" metal:fill-slot="content">

<p tal:condition="python:not context.is_view_ok()">
 You are not allowed to view this page.</p>

<tal:block tal:condition="context/is_view_ok">

 <!-- Action buttons -->
 <div class="action-buttons" style="margin-bottom: 1em;">
  <a tal:attributes="href string:ci?@template=item"
     class="btn btn-primary">New Configuration Item</a>
  <a tal:attributes="href string:ci?@action=export_csv"
     class="btn btn-secondary">Export to CSV</a>
 </div>

 <!-- Search and Filter Section -->
 <div class="search-filters" style="background: #f5f5f5; padding: 1em; margin-bottom: 1em; border-radius: 4px;">
  <form method="GET" action="ci" style="margin: 0;">

   <!-- Search box -->
   <div style="margin-bottom: 0.5em;" tal:define="search_val python:request.form.getvalue('@search_text', '')">
    <label for="search_text">Search:</label>
    <input type="text" id="search_text" name="@search_text"
           tal:attributes="value python:search_val or ''"
           placeholder="Search by name, location..." style="width: 300px; margin-right: 1em;">
    <input type="submit" value="Search">
   </div>

   <!-- Filter dropdowns -->
   <div style="margin-bottom: 0.5em;">
    <label for="filter_type">Type:</label>
    <select id="filter_type" name="type" onchange="this.form.submit()" style="margin-right: 1em;">
     <option value="">All Types</option>
     <option value="1">Server</option>
     <option value="2">Network Device</option>
     <option value="3">Storage</option>
     <option value="4">Software</option>
     <option value="5">Service</option>
     <option value="6">Virtual Machine</option>
    </select>

    <label for="filter_status">Status:</label>
    <select id="filter_status" name="status" onchange="this.form.submit()" style="margin-right: 1em;">
     <option value="">All Statuses</option>
     <option value="1">Planning</option>
     <option value="2">Ordered</option>
     <option value="3">In Stock</option>
     <option value="4">Deployed</option>
     <option value="5">Active</option>
     <option value="6">Maintenance</option>
     <option value="7">Retired</option>
    </select>

    <label for="filter_criticality">Criticality:</label>
    <select id="filter_criticality" name="criticality" onchange="this.form.submit()" style="margin-right: 1em;">
     <option value="">All Criticality Levels</option>
     <option value="1">Very Low</option>
     <option value="2">Low</option>
     <option value="3">Medium</option>
     <option value="4">High</option>
     <option value="5">Very High</option>
    </select>
   </div>

   <!-- Quick Filters and Clear Filters -->
   <div>
    <strong>Quick Filters:</strong>
    <a href="?type=1&status=5" style="margin: 0 0.5em;">Active Servers</a>
    <a href="?" style="margin-left: 1em;">Clear Filters</a>
   </div>
  </form>
 </div>

 <!-- CI list with sorting -->
 <tal:block tal:define="
   type_val python:request.form.getvalue('type', '');
   status_val python:request.form.getvalue('status', '');
   crit_val python:request.form.getvalue('criticality', '');
   search_val python:request.form.getvalue('@search_text', '');
   sort_val python:request.form.getvalue('@sort', '');
   filterspec python:{};
   dummy1 python:type_val and filterspec.update({'type': type_val}) or None;
   dummy2 python:status_val and filterspec.update({'status': status_val}) or None;
   dummy3 python:crit_val and filterspec.update({'criticality': crit_val}) or None;
   all_ci_ids python:db.ci.filter(None, filterspec);
   ci_ids python:[ci_id for ci_id in all_ci_ids if not search_val or search_val.lower() in (db.ci.getnode(ci_id).name.lower() + ' ' + (db.ci.getnode(ci_id).location or '')).lower()];
   sorted_ids python:sorted(ci_ids, key=lambda x: (db.ci.getnode(x).get(sort_val[1:] if sort_val and sort_val.startswith('-') else sort_val or 'id') or '', x), reverse=bool(sort_val and sort_val.startswith('-')));
   batch python:utils.Batch(sorted_ids, request.pagesize, request.startwith);
   ">
  <p tal:condition="python:not sorted_ids">
   No configuration items found. Try adjusting your search criteria or click "New Configuration Item" to create one.
  </p>

  <table class="list" tal:condition="python:sorted_ids" tal:define="
    current_sort python:sort_val or 'id';
    params_list python:[k + '=' + v for k, v in [('type', type_val), ('status', status_val), ('criticality', crit_val), ('@search_text', search_val)] if v];
    base_params python:'&'.join(params_list);
    ">
   <thead>
    <tr>
     <th><a tal:attributes="href string:?${base_params}&@sort=id">ID</a></th>
     <th><a tal:attributes="href string:?${base_params}&@sort=name">Name</a></th>
     <th><a tal:attributes="href string:?${base_params}&@sort=type">Type</a></th>
     <th><a tal:attributes="href string:?${base_params}&@sort=status">Status</a></th>
     <th><a tal:attributes="href string:?${base_params}&@sort=criticality">Criticality</a></th>
     <th>Location</th>
    </tr>
   </thead>
   <tbody>
    <tr tal:repeat="ci batch">
      <td tal:content="ci/id">&nbsp;</td>
      <td>
       <a tal:attributes="href string:ci${ci/id}"
          tal:content="python:ci.name.plain() or '[no name]'">name</a>
      </td>
      <td tal:content="python:ci.type.plain() or ''">&nbsp;</td>
      <td tal:content="python:ci.status.plain() or ''">&nbsp;</td>
      <td tal:content="python:ci.criticality.plain() or ''">&nbsp;</td>
      <td tal:content="python:ci.location.plain() if hasattr(ci, 'location') and ci.location else ''">&nbsp;</td>
    </tr>
   </tbody>
  </table>
 </tal:block>

</tal:block>

</td>
</tal:block>
