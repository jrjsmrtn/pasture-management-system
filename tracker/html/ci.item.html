<!-- SPDX-FileCopyrightText: 2025 Georges Martin <jrjsmrtn@gmail.com> -->
<!-- SPDX-License-Identifier: MIT -->
<tal:block metal:use-macro="templates/page/macros/icing">
<title metal:fill-slot="head_title">
<tal:block condition="context/id" i18n:translate=""
 >CI <tal:x tal:content="context/id" i18n:name="id"
 />: <tal:x content="context/name" i18n:name="name"
 /> - <tal:x content="config/TRACKER_NAME" i18n:name="tracker"
/></tal:block>
<tal:block condition="not:context/id" i18n:translate=""
 >New Configuration Item - <span tal:replace="config/TRACKER_NAME" i18n:name="tracker"
/></tal:block>
</title>
<tal:block metal:fill-slot="body_title">
 <span tal:condition="python: not (context.id or context.is_edit_ok())"
  tal:omit-tag="python:1" i18n:translate="">New Configuration Item</span>
 <span tal:condition="python: not context.id and context.is_edit_ok()"
  tal:omit-tag="python:1" i18n:translate="">New Configuration Item Editing</span>
 <span tal:condition="python: context.id and not context.is_edit_ok()"
  tal:omit-tag="python:1" i18n:translate="">CI<tal:x
  replace="context/id" i18n:name="id" /></span>
 <span tal:condition="python: context.id and context.is_edit_ok()"
  tal:omit-tag="python:1" i18n:translate="">CI<tal:x
  replace="context/id" i18n:name="id" /> Editing</span>
</tal:block>

<td class="content" metal:fill-slot="content">

<p tal:condition="python:not (context.is_view_ok()
 or request.user.hasRole('Anonymous'))" i18n:translate="">
 You are not allowed to view this page.</p>

<p tal:condition="python:not context.is_view_ok()
 and request.user.hasRole('Anonymous')" i18n:translate="">
 Please login with your username and password.</p>

<div tal:condition="context/is_view_ok">

<form method="POST" name="ciForm"
      onSubmit="return submit_once()" enctype="multipart/form-data"
      tal:attributes="action context/designator">

<table class="form">
<tr>
 <th class="required" i18n:translate="">Name</th>
 <td colspan=3 tal:content="structure python:context.name.field(size=60)">name</td>
</tr>

<tr>
 <th class="required" i18n:translate="">Type</th>
 <td tal:content="structure context/type/menu">type</td>
 <th class="required" i18n:translate="">Status</th>
 <td tal:content="structure context/status/menu">status</td>
</tr>

<tr>
 <th i18n:translate="">Location</th>
 <td colspan=3 tal:content="structure python:context.location.field(size=60)">location</td>
</tr>

<tr>
 <th i18n:translate="">Owner</th>
 <td tal:content="structure context/owner/menu">owner</td>
 <th i18n:translate="">Criticality</th>
 <td tal:content="structure context/criticality/menu">criticality</td>
</tr>

<tr>
 <th i18n:translate="">Description</th>
 <td colspan=3>
  <textarea name="description" rows="3" cols="60"
            tal:content="python:context.description.plain()"
  ></textarea>
 </td>
</tr>

<!-- Server/VM specific fields: show all when creating new, filter by type when editing -->
<tr>
 <th i18n:translate="">CPU Cores</th>
 <td tal:content="structure python:context.cpu_cores.field(size=10)">cpu_cores</td>
 <th i18n:translate="">RAM (GB)</th>
 <td tal:content="structure python:context.ram_gb.field(size=10)">ram_gb</td>
</tr>

<tr>
 <th i18n:translate="">Operating System</th>
 <td colspan=3 tal:content="structure python:context.os.field(size=60)">os</td>
</tr>

<!-- IP Address and Ports -->
<tr>
 <th i18n:translate="">IP Address</th>
 <td tal:content="structure python:context.ip_address.field(size=20)">ip_address</td>
 <th i18n:translate="">Ports</th>
 <td tal:content="structure python:context.ports.field(size=10)">ports</td>
</tr>

<!-- Storage specific -->
<tr>
 <th i18n:translate="">Capacity (GB)</th>
 <td tal:content="structure python:context.capacity_gb.field(size=10)">capacity_gb</td>
 <th i18n:translate="">Version</th>
 <td tal:content="structure python:context.version.field(size=30)">version</td>
</tr>

<!-- Vendor -->
<tr>
 <th i18n:translate="">Vendor</th>
 <td colspan=3 tal:content="structure python:context.vendor.field(size=60)">vendor</td>
</tr>

<!-- ITIL Integration -->
<tr tal:condition="context/id">
 <th i18n:translate="">Related Issues</th>
 <td colspan=3>
  <span tal:replace="structure context/related_issues/field" />
  <roundup-classhelper data-search-with="title,status[],priority[],id">
    <span tal:condition="context/is_edit_ok"
          tal:replace="structure python:db.issue.classhelp('id,title,status',
                       property='related_issues', width='600')" />
  </roundup-classhelper>
  <tal:block tal:condition="context/related_issues">
   <br><span i18n:translate="">View:</span>
   <ul style="margin: 0; padding-left: 20px;">
    <li tal:repeat="issue context/related_issues">
     <a tal:attributes="href string:issue${issue/id}"
        tal:content="python:f'issue{issue.id}: {issue.title}'">issue link</a>
     (<span tal:replace="issue/status/name">status</span>)
    </li>
   </ul>
  </tal:block>
 </td>
</tr>

<tr tal:condition="context/id">
 <th i18n:translate="">Related Changes</th>
 <td colspan=3>
  <span tal:replace="structure context/related_changes/field" />
  <roundup-classhelper data-search-with="title,status[],priority[],id">
    <span tal:condition="context/is_edit_ok"
          tal:replace="structure python:db.change.classhelp('id,title,status',
                       property='related_changes', width='600')" />
  </roundup-classhelper>
  <tal:block tal:condition="context/related_changes">
   <br><span i18n:translate="">View:</span>
   <ul style="margin: 0; padding-left: 20px;">
    <li tal:repeat="change context/related_changes">
     <a tal:attributes="href string:change${change/id}"
        tal:content="python:f'change{change.id}: {change.title}'">change link</a>
     (<span tal:replace="change/status/name">status</span>)
    </li>
   </ul>
  </tal:block>
 </td>
</tr>

<tr>
 <td>&nbsp;</td>
 <td colspan=3>
  <table class="form">
   <tr>
    <th i18n:translate="">Created</th>
    <td tal:content="context/creation">creation</td>
    <th i18n:translate="">Creator</th>
    <td tal:content="structure context/creator/field">creator</td>
   </tr>
   <tr tal:condition="context/id">
    <th i18n:translate="">Last Activity</th>
    <td tal:content="context/activity">activity</td>
    <th i18n:translate="">Last Actor</th>
    <td tal:content="structure context/actor/field">actor</td>
   </tr>
  </table>
 </td>
</tr>

<tr>
 <td>&nbsp;</td>
 <td colspan=3 tal:content="structure context/submit">
  submit button will go here
 </td>
</tr>

</table>

</form>

<!-- CI Relationships section for existing CIs -->
<tal:block condition="context/id">
 <h3 i18n:translate="">CI Relationships</h3>

 <div class="relationships-section">
  <tal:block tal:define="
   outgoing_rels python:db.cirelationship.filter(None, {'source_ci': str(context.id)});
   incoming_rels python:db.cirelationship.filter(None, {'target_ci': str(context.id)})
  ">

   <!-- Display outgoing relationships -->
   <tal:block tal:condition="outgoing_rels">
    <h4 i18n:translate="">Dependencies (This CI → Others)</h4>
    <table class="list">
     <tr>
      <th i18n:translate="">Relationship Type</th>
      <th i18n:translate="">Target CI</th>
      <th i18n:translate="">Description</th>
      <th i18n:translate="">Actions</th>
     </tr>
     <tr tal:repeat="rel outgoing_rels">
      <td tal:content="rel/relationship_type/name">type</td>
      <td tal:content="rel/target_ci/name">target</td>
      <td tal:content="python:rel.description or '-'">description</td>
      <td>
       <a tal:attributes="href string:cirelationship${rel}?@action=retire"
          onclick="return confirm('Remove this relationship?')"
          i18n:translate="">Remove</a>
      </td>
     </tr>
    </table>
   </tal:block>

   <!-- Display incoming relationships -->
   <tal:block tal:condition="incoming_rels">
    <h4 i18n:translate="">Referenced By (Others → This CI)</h4>
    <table class="list">
     <tr>
      <th i18n:translate="">Source CI</th>
      <th i18n:translate="">Relationship Type</th>
      <th i18n:translate="">Description</th>
     </tr>
     <tr tal:repeat="rel incoming_rels">
      <td tal:content="rel/source_ci/name">source</td>
      <td tal:content="rel/relationship_type/name">type</td>
      <td tal:content="python:rel.description or '-'">description</td>
     </tr>
    </table>
   </tal:block>

   <tal:block tal:condition="python:not outgoing_rels and not incoming_rels">
    <p class="empty-list-message" i18n:translate="">
     No relationships defined for this CI.
    </p>
   </tal:block>

   <!-- Add Relationship button -->
   <div class="action-buttons">
    <a tal:attributes="href string:cirelationship?@template=item&source_ci=${context/id}"
       class="btn btn-primary" i18n:translate="">Add Relationship</a>
    <a href="#" id="view-dependencies-btn" class="btn btn-secondary"
       i18n:translate="">View Dependencies</a>
   </div>
  </tal:block>
 </div>
</tal:block>

<!-- History section for existing CIs -->
<tal:block condition="context/id">
 <h3 i18n:translate="">History</h3>
 <table class="history" tal:content="structure context/history">
  history goes here
 </table>
</tal:block>

</div>

</td>
</tal:block>
